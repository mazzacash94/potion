<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>PayPerDay</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
</head>

<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar-->
        <div class="border-end bg-white" id="sidebar-wrapper">
            <div class="sidebar-heading border-bottom bg-light">PayPerDay</div>
            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action list-group-item-light p-3" id="adminSection">Admin</a>
                <a class="list-group-item list-group-item-action list-group-item-light p-3"
                    id="employeeSection">Employee</a>
                <a class="list-group-item list-group-item-action list-group-item-light p-3"
                    id="companySection">Company</a>
            </div>
        </div>
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="connect">Connect</button>
                </div>
            </nav>
            <div id="adminPage" style="display:none; text-align: center">
                <!-- Page content-->
                <div class="container-fluid">
                    <h1 class="mt-4">Admin</h1>
                    <h2 class="mt-4">Add Company</h2>
                    <hr>

                    <label for="companyName">Name:</label><br>
                    <input type="text" id="companyName" name="companyName">
                    <hr>

                    <label for="address">Address:</label><br>
                    <input type="text" id="companyAddress" name="companyAddress">
                    <hr>

                    <button id="addCompanyButton">Submit</button>
                    <hr>
                    <h2 class="mt-4">Companies List</h2>
                    <hr>
                    <button id="showCompaniesList">Show List</button>
                    <hr>
                    <ul id="companiesList"></ul>
                </div>
            </div>
            <div id="employeePage" style="display:none; text-align: center">
                <!-- Page content-->
                <div class="container-fluid">
                    <label for="days">Add Days :</label><br>
                    <input type="text" id="days" name="days">
                    <hr>
                    <button id="addDays">Submit</button>
                    <hr>
                    <button id="claim">Claim Salary</button>
                </div>
            </div>
            <div id="companyPage" style="display:none; text-align: center">
                <!-- Page content-->
                <div class="container-fluid">
                    <h1 class="mt-4">Company</h1>
                    <hr>
                    <h2 class="mt-4">Add Employee</h2>
                    <hr>
                    <label for="wallet">Wallet : </label><br>
                    <input type="text" id="wallet" name="wallet">
                    
                    <hr>

                    <label for="fname">First name:</label><br>
                    <input type="text" id="fname" name="fname">
                    <hr>

                    <label for="lname">Last name:</label><br>
                    <input type="text" id="lname" name="lname">
                    <hr>

                    <label for="salary">Salary:</label><br>
                    <input type="text" id="salary" name="salary">
                    <hr>

                    <button id="addEmployeeButton">Submit</button>
                    <hr>

                    <h2 class="mt-4">Employees List</h2>
                    <hr>
                    <button id="showListEmployees">Show List</button>
                    <hr>
                    <ul id="employeesList"></ul>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script type="module">
        import { ethers } from "https://cdn.ethers.io/lib/ethers-5.2.esm.min.js";

        var account;

        ethereum.on("accountsChanged", (newAccount) => {
            account = newAccount;
            connectButton.innerText = account;
        });

        // A Web3Provider wraps a standard Web3 provider, which is
        // what MetaMask injects as window.ethereum into each page
        const provider = new ethers.providers.Web3Provider(window.ethereum);

        // The MetaMask plugin also allows signing transactions to
        // send ether and pay to change state within the blockchain.
        // For this, you need the account signer...
        const signer = provider.getSigner();

        const contractABI =
            [
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "amount",
                            "type": "uint256"
                        }
                    ],
                    "name": "addDays",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "companiesCounter",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "name": "_companiesList",
                    "outputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "_companiesInfo",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        },
                        {
                            "internalType": "address",
                            "name": "wallet",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "employees",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "_employeesInfo",
                    "outputs": [
                        {
                            "internalType": "address",
                            "name": "company",
                            "type": "address"
                        },
                        {
                            "internalType": "string",
                            "name": "firstName",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "lastName",
                            "type": "string"
                        },
                        {
                            "internalType": "uint256",
                            "name": "salary",
                            "type": "uint256"
                        },
                        {
                            "internalType": "uint256",
                            "name": "startDate",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "wallet",
                            "type": "address"
                        },
                        {
                            "internalType": "string",
                            "name": "name",
                            "type": "string"
                        }
                    ],
                    "name": "addCompany",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "wallet",
                            "type": "address"
                        },
                        {
                            "internalType": "string",
                            "name": "firstName",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "lastName",
                            "type": "string"
                        },
                        {
                            "internalType": "uint256",
                            "name": "salary",
                            "type": "uint256"
                        }
                    ],
                    "name": "addEmployee",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "account",
                            "type": "address"
                        }
                    ],
                    "name": "balanceOf",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "claimSalary",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "spender",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "addedValue",
                            "type": "uint256"
                        }
                    ],
                    "name": "increaseAllowance",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        },
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "name": "_employeesList",
                    "outputs": [
                        {
                            "internalType": "address",
                            "name": "company",
                            "type": "address"
                        },
                        {
                            "internalType": "string",
                            "name": "firstName",
                            "type": "string"
                        },
                        {
                            "internalType": "string",
                            "name": "lastName",
                            "type": "string"
                        },
                        {
                            "internalType": "uint256",
                            "name": "salary",
                            "type": "uint256"
                        },
                        {
                            "internalType": "uint256",
                            "name": "startDate",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                }
            ]

        const contractAddress = "0x675Ff84eF835d902a08CD49A2e94556974ab6093";

        const contractGetter = new ethers.Contract(contractAddress, contractABI, provider);
        const contractSetter = new ethers.Contract(contractAddress, contractABI, signer);

        const adminPage = document.getElementById("adminPage");
        const employeePage = document.getElementById("employeePage");
        const companyPage = document.getElementById("companyPage");
        const adminSection = document.getElementById("adminSection");
        const employeeSection = document.getElementById("employeeSection");
        const companySection = document.getElementById("companySection");
        const connectButton = document.getElementById("connect");

        adminSection.addEventListener("click", () => {
            employeePage.style.display = "none";
            adminPage.style.display = "block";
            companyPage.style.display = "none";
        })

        employeeSection.addEventListener("click", () => {
            adminPage.style.display = "none";
            employeePage.style.display = "block";
            companyPage.style.display = "none";
        })

        companySection.addEventListener("click", () => {
            adminPage.style.display = "none";
            employeePage.style.display = "none";
            companyPage.style.display = "block";
        })

        connectButton.addEventListener("click", () => {
            connect();
        })

        async function connect() {
            // MetaMask requires requesting permission to connect users accounts
            account = await provider.send("eth_requestAccounts", []);
            connectButton.innerText = account;
        }

        // Admin Page Side

        const companyName = document.getElementById("companyName");
        const companyAddress = document.getElementById("companyAddress");
        const addCompanyButton = document.getElementById("addCompanyButton");
        const companiesList = document.getElementById("companiesList");
        const showCompaniesList = document.getElementById("showCompaniesList");

        addCompanyButton.addEventListener("click", () => {
            addCompanyFun();
        })

        showCompaniesList.addEventListener("click", () => {
            getCompanies();
        })

        async function addCompanyFun() {
            let companyAddr = companyAddress.value;
            let compName = companyName.value;
            let sal = salary.value;
            let addr = await signer.getAddress();
            let overrides = {
                "from": addr
            };
            let tx = await contractSetter.addCompany(companyAddr, compName, overrides);
            let receipt = await tx.wait();
            console.log(receipt.transactionHash);
            alert("Transaction mined : " + receipt.transactionHash);
            window.location.reload()
        }

        async function getCompanies() {
            let addr = await signer.getAddress();
            let supply = await contractGetter.companiesCounter();
            for (let i = 0; i < supply; i++) {
                let companyAddr = await contractGetter._companiesList(i);
                let info = await contractGetter._companiesInfo(companyAddr);
                let supply = info.employees;
                let convertedSupply = ethers.BigNumber.from(supply).toString();
                let row1 = document.createElement("li");
                let row2 = document.createElement("li");
                let row3 = document.createElement("li");
                let lineH = document.createElement("hr");
                let lineB = document.createElement("br");
                row1.appendChild(document.createTextNode(`${"Company Name : " + info.name}`));
                companiesList.appendChild(row1);
                row2.appendChild(document.createTextNode(`${"Address : " + info.wallet}`));
                companiesList.appendChild(row2);
                row3.appendChild(document.createTextNode(`${"N° Employees : " + convertedSupply}`));
                companiesList.appendChild(row3);
                companiesList.appendChild(lineH);
            }
        }

        // Company Page Side

        const addEmployeeButton = document.getElementById("addEmployeeButton");
        const wallet = document.getElementById("wallet");
        const firstName = document.getElementById("fname");
        const lastName = document.getElementById("lname");
        const salary = document.getElementById("salary");
        const employeesList = document.getElementById("employeesList");
        const showListEmployees = document.getElementById("showListEmployees");

        addEmployeeButton.addEventListener("click", () => {
            addEmployeeFun();
        })

        showListEmployees.addEventListener("click", () => {
            getCompanyEmployees();
        })

        async function addEmployeeFun() {
            let wall = wallet.value
            let fname = firstName.value;
            let lname = lastName.value;
            let sal = salary.value;
            console.log(sal)
            let addr = await signer.getAddress();
            let overrides = {
                "from": addr
            };
            let tx = await contractSetter.addEmployee(wall, fname, lname, sal, overrides);
            let receipt = await tx.wait();
            console.log(receipt.transactionHash);
            alert("Transaction mined : " + receipt.transactionHash);
            window.location.reload()
        }

        async function getCompanyInfo(addr) {
            let info = await contractGetter._companiesInfo(addr);
            let supply = info.employees;
            let convertedSupply = ethers.BigNumber.from(supply).toString();
            return convertedSupply;
        }

        async function getCompanyEmployees() {
            let addr = await signer.getAddress();
            let supply = await getCompanyInfo(addr);
            for (let i = 0; i < supply; i++) {
                let info = await contractGetter._employeesList(addr, i);
                console.log(info);
                console.log(info.firstName);
                console.log(info.lastName);
                console.log(info.salary);
                let row1 = document.createElement("li");
                let row2 = document.createElement("li");
                let row3 = document.createElement("li");
                let row4 = document.createElement("li");
                let lineH = document.createElement("hr");
                let lineB = document.createElement("br");
                row1.appendChild(document.createTextNode(`${"First Name : " + info.firstName}`));
                employeesList.appendChild(row1);
                row2.appendChild(document.createTextNode(`${"Last Name : " + info.lastName}`));
                employeesList.appendChild(row2);
                row3.appendChild(document.createTextNode(`${"Salary : " + info.salary / 10 ** 18}`));
                employeesList.appendChild(row3);
                row4.appendChild(document.createTextNode(`${"Wallet : " + info.wallet}`));
                employeesList.appendChild(row4);
                employeesList.appendChild(lineH);
            }
        }

        // Employee Page Side

        const days = document.getElementById("days");
        const addDaysButton = document.getElementById("addDays");
        const claim = document.getElementById("claim");

        addDaysButton.addEventListener("click", () => {
            addDaysFun();
        })

        claim.addEventListener("click", () => {
            claimFun();
        })
        
        async function addDaysFun() {
            let daysss = days.value;
            let addr = await signer.getAddress();
            let overrides = {
                "from": addr
            };
            let tx = await contractSetter.addDays(daysss, overrides);
            let receipt = await tx.wait();
            console.log(receipt.transactionHash);
            alert("Transaction mined : " + receipt.transactionHash);
            window.location.reload()
        }

        async function claimFun() {
            let addr = await signer.getAddress();
            let overrides = {
                "from": addr
            };
            let tx = await contractSetter.claimSalary(overrides);
            let receipt = await tx.wait();
            console.log(receipt.transactionHash);
            alert("Transaction mined : " + receipt.transactionHash);
            window.location.reload()
        }

    </script>
</body>

</html>